<!doctype html>
<html>
  <head>
  </head>
  <body>
    <button id="create-iframe">Create IFrame</button>
    <script>
      // document.getElementById('iframe1').contentWindow.postMessage("hello to A", "*");
      // document.getElementById('iframe2').contentWindow.postMessage("hello to B", "*");

      var ui = {
        createIframe: document.getElementById('create-iframe')
      };

      var iframes = {};
      var id = 1;

      class PlaygroundMessageChannel {
        constructor() {
          this.source = {};
          this.destination = {};
        }
      }

      class MessagingService {
        // channel as in web-sockets
        createChannel() {
          var messageChannel = new PlaygroundMessageChannel();

          // port1: is the dApp
          // port2: is Firebase, the other party, etc.

          return messageChannel;
        }
      }

      // is this akin to the old Wallet class?
      // Is Metamask a "node"?
      // It should be able to listen *some* messages.
      // Some are handled, some are relayed via MessasingService.
      // Playground should listen to install and then open the app.
      // How? Do we have its URL somewhere? Maybe in the manifest?
      class PlaygroundNode {
        constructor() {
          this.messagingService = new MessagingService();
        }
      }

      // Try this:
      // https://developer.mozilla.org/en-US/docs/Web/API/MessagePort
      //
      // Dapp must ask the wallet (via CF.js) to sign something.
      function createIframe() {
        var iframe = document.createElement('iframe');
        iframe.id = 'iframe-' + id;
        iframe.src = 'a.html';

        var dapp = {
          window: null,
          subscribers: [],
          sendMessage: function (message) {
            this.window.postMessage(message, '*');
          },
          dispatchMessage: function (event) {
            this.subscribers.forEach(function (callback) {
              callback(event);
            });
          },
          onMessage: function (callback) {
            this.subscribers.push(callback);
          }
        };

        document.body.appendChild(iframe);

        iframe.contentWindow.addEventListener('message', dapp.dispatchMessage.bind(dapp));
        dapp.window = iframe.contentWindow;

        iframes[iframe.id] = dapp;
      }

      ui.createIframe.addEventListener('click', createIframe);
    </script>
  </body>
</html>
