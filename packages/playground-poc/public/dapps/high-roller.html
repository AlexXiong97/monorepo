<h1>High Roller</h1>
<div id="splash-screen">
  <button id="send-message">Play with someone</button>
</div>
<div id="game-screen" style="display: none">
  <button id="propose-acceptable-state">Propose acceptable state</button>
  <button id="propose-rejectable-state">Propose rejectable state</button>
  <p><label id="status"></label></p>
</div>
<script src="https://unpkg.com/eventemitter3@latest/umd/eventemitter3.min.js"></script>
<script src="/scripts/mini-cf.js"></script>
<script>
  (async () => {
    const nodeProvider = new NodeProvider();
    await nodeProvider.connect();

    const client = new cf.Client(nodeProvider);

    const manifest = {
      name: 'High Roller',
      version: '0.0.1',
      url: 'dapps/high-roller.html',
      address: '0x822c045f6F5e7E8090eA820E24A5f327C4E62c96'
    };

    const appFactory = client.createAppFactory(manifest);

    var ui = {
      sendMessage: document.getElementById('send-message'),
      proposeAcceptableState: document.getElementById('propose-acceptable-state'),
      proposeRejectableState: document.getElementById('propose-rejectable-state'),
    };

    ui.sendMessage.addEventListener('click', function () {
      nodeProvider.emit('requestPlayer', { appDefinition: manifest });
      nodeProvider.once('matchedPlayer', (data) => {
        appFactory.proposeInstall(data.peerAddress, {
          // Terms goes here...
        });
      });
    });

    client.once('install', (appInstance) => {
      // Move all this.
      document.getElementById('send-message').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';

      ui.proposeAcceptableState.addEventListener('click', () => {
        appInstance.proposeState({ move: 'forward' });
      });

      ui.proposeRejectableState.addEventListener('click', () => {
        appInstance.proposeState({ move: 'backward' });
      });
    });

    client.on('proposeState', (appInstance, oldState, newState) => {
      const state = JSON.parse(newState);
      if (state.move === 'forward') {
        appInstance.acceptState(state);
      } else {
        appInstance.rejectState(state);
      }
    });

    client.on('acceptState', (appInstance) => {
      document.getElementById('status').innerText = `${appInstance.peerAddress} accepted your state`;
    });

    client.on('rejectState', (appInstance) => {
      document.getElementById('status').innerText = `${appInstance.peerAddress} rejected your state`;
    });
  })();
</script>
